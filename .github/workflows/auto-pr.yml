name: Continuous Pull To Development

on:
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  open-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${GITHUB_REF_NAME}"

          EXISTING_PR=$(gh pr list \
            --base dev \
            --head "$BRANCH" \
            --state open \
            --json number \
            --jq 'length')

          echo "existing_pr=$EXISTING_PR" >> $GITHUB_OUTPUT

      - name: Create PR if diff exists and PR not found
        if: steps.check_pr.outputs.existing_pr == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${GITHUB_REF_NAME}"

          gh pr create \
            --base dev \
            --head "$BRANCH" \
            --title "$BRANCH â†’ dev - Continuous Integration" \
            --body "Automated PR created from push to \`$BRANCH\`" \
            --label "feature"
